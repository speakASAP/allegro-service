services:
  api-gateway:
    build:
      context: .
      dockerfile: services/api-gateway/Dockerfile
    container_name: allegro-api-gateway-green
    ports:
      - "${API_GATEWAY_PORT:-3411}:3411"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - SERVICE_NAME=${SERVICE_NAME:-allegro}
      - API_GATEWAY_PORT=${API_GATEWAY_PORT:-3411}
      - ALLEGRO_SERVICE_URL=${ALLEGRO_SERVICE_URL:-http://allegro-service-green:3403}
      - IMPORT_SERVICE_URL=${IMPORT_SERVICE_URL:-http://allegro-import-service-green:3406}
      - SETTINGS_SERVICE_URL=${SETTINGS_SERVICE_URL:-http://allegro-settings-service-green:3408}
      - ALLEGRO_SETTINGS_SERVICE_PORT=${ALLEGRO_SETTINGS_SERVICE_PORT:-3408}
      - AUTH_SERVICE_URL=${AUTH_SERVICE_URL}
      - JWT_SECRET=${JWT_SECRET}
      - NOTIFICATION_SERVICE_URL=${NOTIFICATION_SERVICE_URL}
      - LOGGING_SERVICE_URL=${LOGGING_SERVICE_URL}
      - HTTP_TIMEOUT=${HTTP_TIMEOUT}
      - GATEWAY_TIMEOUT=${GATEWAY_TIMEOUT}
      - CORS_ORIGIN=${CORS_ORIGIN}
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT:-5432}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME:-allegro}
      - DATABASE_URL=${DATABASE_URL}
    deploy:
      resources:
        limits:
          memory: 200M
        reservations:
          memory: 70M
    networks:
      - nginx-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3411/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  allegro-service:
    build:
      context: .
      dockerfile: services/allegro-service/Dockerfile
    container_name: allegro-service-green
    ports:
      - "${ALLEGRO_SERVICE_PORT:-3403}:3403"
    volumes:
      - ./logs:/app/logs

    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - SERVICE_NAME=${SERVICE_NAME:-allegro}
      - ALLEGRO_SERVICE_PORT=${ALLEGRO_SERVICE_PORT:-3403}
      - AUTH_SERVICE_URL=${AUTH_SERVICE_URL}
      - JWT_SECRET=${JWT_SECRET}
      - NOTIFICATION_SERVICE_URL=${NOTIFICATION_SERVICE_URL}
      - LOGGING_SERVICE_URL=${LOGGING_SERVICE_URL}
      - ALLEGRO_CLIENT_ID=${ALLEGRO_CLIENT_ID}
      - ALLEGRO_CLIENT_SECRET=${ALLEGRO_CLIENT_SECRET}
      - ALLEGRO_REDIRECT_URI=${ALLEGRO_REDIRECT_URI}
      - ALLEGRO_AUTH_URL=${ALLEGRO_AUTH_URL:-https://allegro.pl/auth/oauth/token}
      - ALLEGRO_AUTH_SANDBOX_URL=${ALLEGRO_AUTH_SANDBOX_URL}
      - ALLEGRO_OAUTH_AUTHORIZE_URL=${ALLEGRO_OAUTH_AUTHORIZE_URL}
      - ALLEGRO_OAUTH_TOKEN_URL=${ALLEGRO_OAUTH_TOKEN_URL}
      - ALLEGRO_API_URL=${ALLEGRO_API_URL:-https://api.allegro.pl}
      - ALLEGRO_API_SANDBOX_URL=${ALLEGRO_API_SANDBOX_URL}
      - ALLEGRO_USE_SANDBOX=${ALLEGRO_USE_SANDBOX:-false}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT:-5432}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME:-allegro}
      - DATABASE_URL=${DATABASE_URL}
    networks:
      - nginx-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3403/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  allegro-import-service:
    build:
      context: .
      dockerfile: services/import-service/Dockerfile
    container_name: allegro-import-service-green
    ports:
      - "${IMPORT_SERVICE_PORT:-3406}:3406"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - SERVICE_NAME=${SERVICE_NAME:-allegro}
      - IMPORT_SERVICE_PORT=${IMPORT_SERVICE_PORT:-3406}
      - AUTH_SERVICE_URL=${AUTH_SERVICE_URL}
      - JWT_SECRET=${JWT_SECRET}
      - NOTIFICATION_SERVICE_URL=${NOTIFICATION_SERVICE_URL}
      - LOGGING_SERVICE_URL=${LOGGING_SERVICE_URL}
      - ALLEGRO_SERVICE_URL=${ALLEGRO_SERVICE_URL:-http://allegro-service-green:3403}
      - IMPORT_CSV_MAX_SIZE=${IMPORT_CSV_MAX_SIZE:-104857600}
      - IMPORT_CSV_BATCH_SIZE=${IMPORT_CSV_BATCH_SIZE:-50}
      - NOTIFICATION_ORDER_CREATED=${NOTIFICATION_ORDER_CREATED:-true}
      - NOTIFICATION_ORDER_UPDATED=${NOTIFICATION_ORDER_UPDATED:-true}
      - NOTIFICATION_STOCK_LOW=${NOTIFICATION_STOCK_LOW:-true}
      - NOTIFICATION_EMAIL_TO=${NOTIFICATION_EMAIL_TO}
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT:-5432}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME:-allegro}
      - DATABASE_URL=${DATABASE_URL}
    networks:
      - nginx-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3406/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  allegro-settings-service:
    build:
      context: .
      dockerfile: services/allegro-settings-service/Dockerfile
    container_name: allegro-settings-service-green
    ports:
      - "${ALLEGRO_SETTINGS_SERVICE_PORT:-3408}:3408"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - SERVICE_NAME=${SERVICE_NAME:-allegro}
      - ALLEGRO_SETTINGS_SERVICE_PORT=${ALLEGRO_SETTINGS_SERVICE_PORT:-3408}
      - AUTH_SERVICE_URL=${AUTH_SERVICE_URL}
      - JWT_SECRET=${JWT_SECRET}
      - NOTIFICATION_SERVICE_URL=${NOTIFICATION_SERVICE_URL}
      - LOGGING_SERVICE_URL=${LOGGING_SERVICE_URL}
      - HTTP_TIMEOUT=${HTTP_TIMEOUT}
      - AUTH_SERVICE_TIMEOUT=${AUTH_SERVICE_TIMEOUT}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT:-5432}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME:-allegro}
      - DATABASE_URL=${DATABASE_URL}
    networks:
      - nginx-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3408/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  frontend:
    build:
      context: .
      dockerfile: services/allegro-frontend-service/Dockerfile
      args:
        - FRONTEND_API_URL=${FRONTEND_API_URL}
    container_name: allegro-frontend-service-green
    ports:
      - "${ALLEGRO_FRONTEND_SERVICE_PORT:-3410}:3410"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
    networks:
      - nginx-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:3410/health"]
      interval: 10s
      timeout: 10s
      retries: 2
      start_period: 10s

networks:
  nginx-network:
    external: true
    name: nginx-network

