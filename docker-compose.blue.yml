services:
  gateway-proxy:
    image: nginx:alpine
    container_name: allegro-service-gateway-proxy-blue
    # Port mapping for health checks only - gateway-proxy is accessed via Docker network (http://gateway-proxy)
    # Host port 3409 (available in 34xx range, mapped to container port 80
    ports:
      - "${GATEWAY_PROXY_PORT:-3409}:80"
    volumes:
      - ./nginx/gateway-proxy.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - nginx-network
    depends_on:
      - allegro
      - settings
      - imports
    restart: unless-stopped
    # Note: nginx configuration uses dynamic DNS resolution (resolver + variables in proxy_pass)
    # This prevents stale IP caching when services restart and get new IP addresses
    # DNS is re-resolved every 10 seconds, and variables in proxy_pass force resolution on each request
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "--tries=1", "http://127.0.0.1/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  api-gateway:
    build:
      context: .
      dockerfile: services/api-gateway/Dockerfile
    container_name: allegro-service-api-gateway-blue
    ports:
      - "${API_GATEWAY_PORT:-3411}:3411"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - SERVICE_NAME=${SERVICE_NAME:-allegro-service}
      - API_GATEWAY_PORT=${API_GATEWAY_PORT:-3411}
      - ALLEGRO_SERVICE_URL=${ALLEGRO_SERVICE_URL:-http://allegro:3403}
      - IMPORT_SERVICE_URL=${IMPORT_SERVICE_URL:-http://imports:3406}
      - SETTINGS_SERVICE_URL=${SETTINGS_SERVICE_URL:-http://settings:3408}
      - ALLEGRO_SETTINGS_SERVICE_PORT=${ALLEGRO_SETTINGS_SERVICE_PORT:-3408}
      - AUTH_SERVICE_URL=${AUTH_SERVICE_URL}
      - JWT_SECRET=${JWT_SECRET}
      - NOTIFICATION_SERVICE_URL=${NOTIFICATION_SERVICE_URL}
      - LOGGING_SERVICE_URL=${LOGGING_SERVICE_URL}
      - HTTP_TIMEOUT=${HTTP_TIMEOUT}
      - GATEWAY_TIMEOUT=${GATEWAY_TIMEOUT}
      - CORS_ORIGIN=${CORS_ORIGIN}
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT:-5432}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME:-allegro}
      - DATABASE_URL=${DATABASE_URL}
    deploy:
      resources:
        limits:
          memory: 200M
        reservations:
          memory: 70M
    networks:
      - nginx-network
    depends_on:
      - gateway-proxy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3411/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  allegro:
    build:
      context: .
      dockerfile: services/allegro-service/Dockerfile
    container_name: allegro-service-blue
    ports:
      - "${ALLEGRO_SERVICE_PORT:-3403}:3403"
    volumes:
      - ./logs:/app/logs

    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - SERVICE_NAME=${SERVICE_NAME:-allegro-service}
      - ALLEGRO_SERVICE_PORT=${ALLEGRO_SERVICE_PORT:-3403}
      - AUTH_SERVICE_URL=${AUTH_SERVICE_URL}
      - JWT_SECRET=${JWT_SECRET}
      - NOTIFICATION_SERVICE_URL=${NOTIFICATION_SERVICE_URL}
      - LOGGING_SERVICE_URL=${LOGGING_SERVICE_URL}
      - ALLEGRO_CLIENT_ID=${ALLEGRO_CLIENT_ID}
      - ALLEGRO_CLIENT_SECRET=${ALLEGRO_CLIENT_SECRET}
      - ALLEGRO_REDIRECT_URI=${ALLEGRO_REDIRECT_URI}
      - ALLEGRO_AUTH_URL=${ALLEGRO_AUTH_URL:-https://allegro.pl/auth/oauth/token}
      - ALLEGRO_AUTH_SANDBOX_URL=${ALLEGRO_AUTH_SANDBOX_URL}
      - ALLEGRO_OAUTH_AUTHORIZE_URL=${ALLEGRO_OAUTH_AUTHORIZE_URL}
      - ALLEGRO_OAUTH_TOKEN_URL=${ALLEGRO_OAUTH_TOKEN_URL}
      - ALLEGRO_API_URL=${ALLEGRO_API_URL:-https://api.allegro.pl}
      - ALLEGRO_API_SANDBOX_URL=${ALLEGRO_API_SANDBOX_URL}
      - ALLEGRO_USE_SANDBOX=${ALLEGRO_USE_SANDBOX:-false}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      - CATALOG_SERVICE_URL=${CATALOG_SERVICE_URL:-http://catalog:3200}
      - WAREHOUSE_SERVICE_URL=${WAREHOUSE_SERVICE_URL:-http://warehouse-microservice:3201}
      - ORDER_SERVICE_URL=${ORDER_SERVICE_URL:-http://orders-microservice:3203}
      - RABBITMQ_URL=${RABBITMQ_URL:-amqp://guest:guest@statex_rabbitmq:5672}
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT:-5432}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME:-allegro}
      - DATABASE_URL=${DATABASE_URL}
    networks:
      - nginx-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3403/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  imports:
    build:
      context: .
      dockerfile: services/imports/Dockerfile
    container_name: allegro-service-imports-blue
    ports:
      - "${IMPORT_SERVICE_PORT:-3406}:3406"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - SERVICE_NAME=${SERVICE_NAME:-allegro-service}
      - IMPORT_SERVICE_PORT=${IMPORT_SERVICE_PORT:-3406}
      - AUTH_SERVICE_URL=${AUTH_SERVICE_URL}
      - JWT_SECRET=${JWT_SECRET}
      - NOTIFICATION_SERVICE_URL=${NOTIFICATION_SERVICE_URL}
      - LOGGING_SERVICE_URL=${LOGGING_SERVICE_URL}
      - ALLEGRO_SERVICE_URL=${ALLEGRO_SERVICE_URL:-http://allegro:3403}
      - IMPORT_CSV_MAX_SIZE=${IMPORT_CSV_MAX_SIZE:-104857600}
      - IMPORT_CSV_BATCH_SIZE=${IMPORT_CSV_BATCH_SIZE:-50}
      - NOTIFICATION_ORDER_CREATED=${NOTIFICATION_ORDER_CREATED:-true}
      - NOTIFICATION_ORDER_UPDATED=${NOTIFICATION_ORDER_UPDATED:-true}
      - NOTIFICATION_STOCK_LOW=${NOTIFICATION_STOCK_LOW:-true}
      - NOTIFICATION_EMAIL_TO=${NOTIFICATION_EMAIL_TO}
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT:-5432}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME:-allegro}
      - DATABASE_URL=${DATABASE_URL}
    networks:
      - nginx-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3406/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  settings:
    build:
      context: .
      dockerfile: services/settings/Dockerfile
    container_name: allegro-service-settings-blue
    ports:
      - "${ALLEGRO_SETTINGS_SERVICE_PORT:-3408}:3408"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - SERVICE_NAME=${SERVICE_NAME:-allegro-service}
      - ALLEGRO_SETTINGS_SERVICE_PORT=${ALLEGRO_SETTINGS_SERVICE_PORT:-3408}
      - AUTH_SERVICE_URL=${AUTH_SERVICE_URL}
      - JWT_SECRET=${JWT_SECRET}
      - NOTIFICATION_SERVICE_URL=${NOTIFICATION_SERVICE_URL}
      - LOGGING_SERVICE_URL=${LOGGING_SERVICE_URL}
      - HTTP_TIMEOUT=${HTTP_TIMEOUT}
      - AUTH_SERVICE_TIMEOUT=${AUTH_SERVICE_TIMEOUT}
      - ALLEGRO_AUTH_URL=${ALLEGRO_AUTH_URL:-https://allegro.pl/auth/oauth/token}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT:-5432}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME:-allegro}
      - DATABASE_URL=${DATABASE_URL}
    networks:
      - nginx-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3408/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  frontend:
    build:
      context: .
      dockerfile: services/frontend/Dockerfile
      args:
        - FRONTEND_API_URL=${FRONTEND_API_URL}
    container_name: allegro-service-frontend-blue
    ports:
      - "${ALLEGRO_FRONTEND_SERVICE_PORT:-3410}:3410"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
    networks:
      - nginx-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:3410/health"]
      interval: 10s
      timeout: 10s
      retries: 2
      start_period: 10s

networks:
  nginx-network:
    external: true
    name: nginx-network
